<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX Status - AUD/USD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .rate-display {
            font-size: 4rem;
            font-weight: bold;
            color: #0d6efd;
        }
        .timestamp {
            color: #6c757d;
        }
        .rate-change {
            font-size: 1.5rem;
            margin-left: 10px;
        }
        .rate-up {
            color: #198754;
        }
        .rate-down {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-5">FX Rate Monitor - AUD/USD</h1>
        
        <div class="card shadow">
            <div class="card-body text-center p-5">
                <h2 class="mb-4">Current Rate</h2>
                <div class="rate-display" id="currentRate">0.0000</div>
                <div class="rate-change" id="rateChange"></div>
                <div class="timestamp mt-3" id="timestamp">Loading...</div>
                
                <div class="mt-5">
                    <button class="btn btn-success btn-lg me-3" onclick="executeTrade('buy')">
                        Buy AUD
                    </button>
                    <button class="btn btn-danger btn-lg" onclick="executeTrade('sell')">
                        Sell AUD
                    </button>
                </div>
                
                <div class="mt-4" id="tradeResult"></div>
            </div>
        </div>

        <div class="card shadow mt-4">
            <div class="card-body">
                <h3>Rate History (Last 10 updates)</h3>
                <canvas id="rateChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        let previousRate = null;
        let rateHistory = [];
        let timeLabels = [];
        let chart = null;

        // Initialize chart
        const ctx = document.getElementById('rateChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'AUD/USD Rate',
                    data: rateHistory,
                    borderColor: 'rgb(13, 110, 253)',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: false,
                        min: 0.60,
                        max: 0.70
                    }
                }
            }
        });

        async function updateRate() {
            try {
                const response = await fetch('/api/fx/rate');
                const data = await response.json();
                
                const currentRate = parseFloat(data.rate);
                document.getElementById('currentRate').textContent = currentRate.toFixed(4);
                document.getElementById('timestamp').textContent = 
                    'Last updated: ' + new Date(data.timestamp).toLocaleString();
                
                // Show rate change
                if (previousRate !== null) {
                    const change = currentRate - previousRate;
                    const changeElement = document.getElementById('rateChange');
                    if (change > 0) {
                        changeElement.innerHTML = '▲ ' + Math.abs(change).toFixed(4);
                        changeElement.className = 'rate-change rate-up';
                    } else if (change < 0) {
                        changeElement.innerHTML = '▼ ' + Math.abs(change).toFixed(4);
                        changeElement.className = 'rate-change rate-down';
                    } else {
                        changeElement.innerHTML = '─ 0.0000';
                        changeElement.className = 'rate-change';
                    }
                }
                
                previousRate = currentRate;

                // Update chart
                const now = new Date().toLocaleTimeString();
                rateHistory.push(currentRate);
                timeLabels.push(now);
                
                if (rateHistory.length > 10) {
                    rateHistory.shift();
                    timeLabels.shift();
                }
                
                chart.update();
                
            } catch (error) {
                console.error('Error fetching rate:', error);
                document.getElementById('timestamp').textContent = 'Error loading rate';
            }
        }

        async function executeTrade(type) {
            const amount = prompt(`Enter amount to ${type} (AUD):`, '1000');
            if (!amount) return;

            try {
                const response = await fetch(`/api/fx/${type}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currencyPair: 'AUD/USD',
                        amount: parseFloat(amount),
                        rate: 0
                    })
                });

                const result = await response.json();
                const resultDiv = document.getElementById('tradeResult');
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>Success!</strong> ${result.message}<br>
                            Amount: ${result.transaction.amount} ${result.transaction.currencyPair}<br>
                            Rate: ${result.transaction.rate.toFixed(4)}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error!</strong> ${result.message}
                        </div>
                    `;
                }

                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 5000);

            } catch (error) {
                console.error('Error executing trade:', error);
            }
        }

        // Update rate every 2 seconds
        updateRate();
        setInterval(updateRate, 2000);
    </script>
</body>
</html>
